
<!DOCTYPE html>
<html lang="cn"
>
<head>
    <title>规模化爬取NCBI - Café de Lyon</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="wb:webmaster" content="3cba1a80be39e3a2" />



<link rel="canonical" href="http://www.lyon0804.com/gui-mo-hua-pa-qu-ncbi.html">

        <meta name="author" content="lyon" />
        <meta name="keywords" content="bioinpormatics,python,spider" />
        <meta name="description" content="在生物信息领域, NCBI(National Center for Biotechnology Information, 美国国家生物信息中心)绝对是必不可少的网站, 该网站提供了很多文章的原始测序数据(SRA)、基因组数据(genome)、核酸库(NT)、蛋白库(NR)、基因信息(gene)、文章数据(PubMed/PMC)、物种分类数据(Taxnomy)、变异数据(SNP)、临床数据(Clinvar)等等大量的数据信息来源, 以及提供blast在线比对服务; 大多数NCBI的数据库都可以在其FTP站点上找到, 但是仍然有一些数据没有被固化成文件, 为了要使用这些数据, 避免每次都手动去网站上查询, 就必须动用一些网络爬虫的手段; 目标 尽量不要动用网络爬虫, 如果可以, 尽量尝试使用bioperl或者biopython等提供的Entrez数据库的API, 这样可以减少NCBI网站的访问压力, 毕竟NCBI是非营利性站点, 给大家提供许多便利, 也需要大家的爱护; 当必须借助网络爬虫时, 尽量控制访问频率; 在以上两条前提之下, 实现规模化的信息爬取; 由于国内网络环境 ..." />

        <meta property="og:site_name" content="Café de Lyon" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="规模化爬取NCBI"/>
        <meta property="og:url" content="http://www.lyon0804.com/gui-mo-hua-pa-qu-ncbi.html"/>
        <meta property="og:description" content="在生物信息领域, NCBI(National Center for Biotechnology Information, 美国国家生物信息中心)绝对是必不可少的网站, 该网站提供了很多文章的原始测序数据(SRA)、基因组数据(genome)、核酸库(NT)、蛋白库(NR)、基因信息(gene)、文章数据(PubMed/PMC)、物种分类数据(Taxnomy)、变异数据(SNP)、临床数据(Clinvar)等等大量的数据信息来源, 以及提供blast在线比对服务; 大多数NCBI的数据库都可以在其FTP站点上找到, 但是仍然有一些数据没有被固化成文件, 为了要使用这些数据, 避免每次都手动去网站上查询, 就必须动用一些网络爬虫的手段; 目标 尽量不要动用网络爬虫, 如果可以, 尽量尝试使用bioperl或者biopython等提供的Entrez数据库的API, 这样可以减少NCBI网站的访问压力, 毕竟NCBI是非营利性站点, 给大家提供许多便利, 也需要大家的爱护; 当必须借助网络爬虫时, 尽量控制访问频率; 在以上两条前提之下, 实现规模化的信息爬取; 由于国内网络环境 ..."/>
        <meta property="article:published_time" content="2016-03-20" />
            <meta property="article:section" content="bioinformatics" />
            <meta property="article:tag" content="bioinpormatics" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="spider" />
            <meta property="article:author" content="lyon" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://www.lyon0804.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://www.lyon0804.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://www.lyon0804.com/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://www.lyon0804.com/theme/css/style.css" type="text/css"/>

        <link href="http://www.lyon0804.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Café de Lyon ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://www.lyon0804.com/" class="navbar-brand">
<img src="http://www.lyon0804.com/static/img/logo.png" width="30px"/> Café de Lyon            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="http://www.lyon0804.com/category/bioinformatics.html">Bioinformatics</a>
                        </li>
                        <li >
                            <a href="http://www.lyon0804.com/category/learning.html">Learning</a>
                        </li>
                        <li >
                            <a href="http://www.lyon0804.com/category/pages.html">Pages</a>
                        </li>
                        <li >
                            <a href="http://www.lyon0804.com/category/photo.html">Photo</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://www.lyon0804.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://www.lyon0804.com/gui-mo-hua-pa-qu-ncbi.html"
                       rel="bookmark"
                       title="Permalink to 规模化爬取NCBI">
                        规模化爬取NCBI
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-03-20T00:00:00+08:00"> Sun 20 March 2016</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://www.lyon0804.com/tag/bioinpormatics.html">bioinpormatics</a>
        /
	<a href="http://www.lyon0804.com/tag/python.html">python</a>
        /
	<a href="http://www.lyon0804.com/tag/spider.html">spider</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>在生物信息领域, <a href="http://www.ncbi.nlm.nih.gov">NCBI(<em>National Center for Biotechnology Information, 美国国家生物信息中心</em>)</a>绝对是必不可少的网站, 该网站提供了很多文章的原始测序数据(SRA)、基因组数据(genome)、核酸库(NT)、蛋白库(NR)、基因信息(gene)、文章数据(PubMed/PMC)、物种分类数据(Taxnomy)、变异数据(SNP)、临床数据(Clinvar)等等大量的数据信息来源, 以及提供blast在线比对服务;</p>
<p>大多数NCBI的数据库都可以在其<a href="ftp.ncbi.nlm.nih.gov">FTP站点</a>上找到, 但是仍然有一些数据没有被固化成文件, 为了要使用这些数据, 避免每次都手动去网站上查询, 就必须动用一些网络爬虫的手段;</p>
<h2>目标</h2>
<ol>
<li>尽量不要动用网络爬虫, 如果可以, 尽量尝试使用bioperl或者biopython等提供的Entrez数据库的API, 这样可以减少NCBI网站的访问压力, 毕竟NCBI是非营利性站点, 给大家提供许多便利, 也需要大家的爱护;</li>
<li>当必须借助网络爬虫时, 尽量控制访问频率;</li>
<li>在以上两条前提之下, 实现规模化的信息爬取;</li>
<li>由于国内网络环境, 需要处理各种网络不稳定造成的连接问题;</li>
<li>由于国内网络环境, 应该实现实时输出, 断点续传的功能;</li>
</ol>
<h2>获取Clinvar转录本信息</h2>
<p>在NCBI的FTP站点上下载的Clinvar数据库(vcf)中, 并没有包含转录本信息, 如果需要对变异注释的结果进行转录本的验证, 就需要获取到Clinvar的转录本信息;</p>
<p>Clinvar通过rs号查询转录本的链接格式为: </p>
<p><code>http://www.ncbi.nlm.nih.gov/clinvar/?term=rs80359578</code></p>
<p>当查询到的转录本条目数量只有一条时, Clinvar会自动跳转到该记录的详细页面, 如上述例子中, 会被自动转到<code>http://www.ncbi.nlm.nih.gov/clinvar/variation/52075/</code>, 网页形式为:</p>
<p><img alt="Clinvar单条" src="http://ww2.sinaimg.cn/large/95202659gw1f2euem0zp4j21kw0x47g0.jpg" /></p>
<p>当查询到的转录本条目数量大于一条时, Clinvar会显示查询到的列表内容, 网页形式为:</p>
<p><img alt="Clinvar多条" src="http://ww3.sinaimg.cn/large/95202659gw1f2euemh9jqj21kw0sw46x.jpg" /></p>
<p>所以不同的页面需要使用不同的解析方式, 具体就不再展开, 大家根据不同的网页自己解析, 示例代码:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>


<span class="k">def</span> <span class="nf">parse_html</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;lxml&#39;</span><span class="p">)</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&#39;faceted_search&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">location_list</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;span&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;ui-button-text&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">location_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s">&#39;x&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maincontent</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&#39;maincontent&#39;</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">maincontent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;h2&#39;</span><span class="p">)</span>
        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_list</span>
</pre></div>


<h2>基本爬虫实现</h2>
<p>完成了网页解析, 下一步就要设计爬虫开始爬取了, 首先不考虑其他问题, 先将网页成功爬取并解析;</p>
<p>由于之后的爬取量会非常大(如Clinvar中大概有11万条rs记录), 需要一些必要的头文件伪装:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>


<span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
        <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span>
        <span class="s">&#39;application/x-www-form-urlencoded;&#39;</span>
        <span class="s">&#39;charset=utf-8&#39;</span>
    <span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
        <span class="s">&#39;User-Agent&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_0) &#39;</span>
        <span class="s">&#39;AppleWebKit/601.1.56 (KHTML, like Gecko) &#39;</span>
        <span class="s">&#39;Version/9.0 Safari/601.1.56&#39;</span>
    <span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
        <span class="s">&#39;Referer&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.ncbi.nlm.nih.gov&#39;</span>
    <span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;Host&#39;</span><span class="p">,</span> <span class="s">&#39;www.ncbi.nlm.nih.gov&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">req</span>
</pre></div>


<p>以上使用了Python3的<code>urllib</code>, 如果使用Python2, 则需要换成对应的request模块;</p>
<p>通过简单伪装之后, 就可以通过rs号进行爬取了:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>


<span class="k">def</span> <span class="nf">get_clinvar_transcript</span><span class="p">(</span><span class="n">rs_string</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.ncbi.nlm.nih.gov/clinvar/?term=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rs_string</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">transcript_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transcript_list</span>
</pre></div>


<h2>网络不稳定问题</h2>
<p>到这里为止, 简单的爬虫功能已经实现, 但是经验告诉我们, 在国内NCBI的访问并不是很稳定, 在爬取过程中也有可能出现很多的网络问题, 常见的异常有: <code>urllib.error.URLError</code>、<code>http.client.IncompleteRead</code>、<code>ConnectionResetError</code>等, 为了防止响应速度过慢, 我们还需要在访问时加上超时设置, 所以还需要解决<code>socket.timeout</code>异常;</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">IncompleteRead</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">timeout</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">try_count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">URLError</span><span class="p">,</span>
                <span class="n">IncompleteRead</span><span class="p">,</span>
                <span class="n">ConnectionResetError</span><span class="p">,</span>
                <span class="n">timeout</span><span class="p">):</span>
            <span class="n">try_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;error occurred, reloading </span><span class="si">%s</span><span class="s"> time: </span><span class="si">%s</span><span class="s">... &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_count</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>


<p>以上只是我暂时发现的一些连接问题, 如果还有其他问题也类似解决;</p>
<h2>并行化爬虫</h2>
<p>由于爬取内容非常多, 单进程的爬虫效率太慢, 为了提升爬虫效率, 应该采用多进程的爬虫结构并行爬取; 这将连带涉及到以下问题:</p>
<ol>
<li>多进程爬虫涉及到并行模型的设计, 由于爬取量非常大, 除了避免进程资源的重复申请, 应该设计在某个时间节点对爬取结果进行一次同步输出; </li>
<li>由于网络爬虫的问题特性, IO速度往往是影响爬虫效率最重要的因素, <strong>异步</strong>结构显得非常重要;</li>
</ol>
<p>Python有非常多的异步并行设计方案, 这里介绍<code>multiprocessing.Pool</code>进程池的异步并行结构: <code>Pool.map_async</code>和<code>Pool.apply_async</code>; </p>
<p>在并行结构同步时, 每个进程返回的内容必须具有连续内存结构, 否则可能导致<code>MaybeEncodingError</code>异常, 当需要同步一些容器结构(如:字典)时, 则需要使用json格式进行中转, 所以需要对之前的函数进行简单的修改:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>


<span class="k">def</span> <span class="nf">get_clinvar_transcript</span><span class="p">(</span><span class="n">rs_string</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.ncbi.nlm.nih.gov/clinvar/?term=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rs_string</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">transcript_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">rs_string</span><span class="p">:</span> <span class="n">transcript_list</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>


<p>以下展示一种异步并行实现方案:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>


<span class="k">def</span> <span class="nf">get_multiprocessing</span><span class="p">(</span><span class="n">rs_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">,</span> <span class="n">threading</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">threading</span><span class="p">)</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rs_string</span> <span class="ow">in</span> <span class="n">rs_list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">get_clinvar_transcript</span><span class="p">,</span>
                                  <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">rs_string</span><span class="p">,))</span>
        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="c"># 同步条件, 这里设置成了当获取的条目数等于进程池大小时同步</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threading</span><span class="p">:</span>

            <span class="c"># 同步输出函数</span>
            <span class="n">output_result</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">)</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_result</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">output_result</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">):</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rs_id</span><span class="p">,</span> <span class="n">variant_list</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">variant_id</span> <span class="ow">in</span> <span class="n">variant_list</span><span class="p">:</span>
                <span class="n">out_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rs_id</span><span class="p">,</span> <span class="n">variant_id</span><span class="p">))</span>
</pre></div>


<p>在以上实现中, rs_list中的rs号被推进固定大小的进程池中, 并执行爬取, 当爬取的结果达到一定的条件时, 执行同步输出, 此时<code>result.get()</code>会形成阻塞, 达到同步的目的; 该条件不应该小于进程池的大小, 否则会由于阻塞而不能达到预定的并行量, 同时也不应该设置太大, 避免出现异常而没有对结果及时输出;</p>
<h2>设置断点</h2>
<p>由于爬取内容很多, 耗时较长, 在实际爬取过程中, 并不能一次性成功爬取完毕, 很难避免中途需要中断暂停等, 设置断点记录爬取状态显得尤为重要; 而实现这一功能却非常简单: 将每一个已经爬取到的rs号记录下来即可, 而当获取欲求的rs号时, 直接排除已经爬取过的rs号;</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">read_already</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">rs_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rs_string</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">rs_string</span>


<span class="k">def</span> <span class="nf">read_rs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">already_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">rs_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rs_string</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">already_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="n">rs_string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_list</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">rs_string</span>
</pre></div>


<p>然后在<code>get_multiprocessing()</code>方法中, 将其中的<code>rs_list</code>改成<code>read_rs</code>, 并在同步输出时, 将rs号也输出到某一文件中;</p>
<h2>设置代理</h2>
<p>当爬取太过频繁时, 可能会面临被站点封锁的风险, 当然最好是不要太过频繁地爬取, 如果非要这么做, 设置代理访问会变得比较安全; 这里不建议使用国内某些网站提供的免费代理, 这些代理地址稳定性太差, 远不如不设置代理时的稳定性; 可能付费的代理会好一些, 这里我没有进行更加深入的尝试;</p>
<h2>代码清单</h2>
<p>最终代码清单为</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*- \#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author = &#39;liangzb&#39;</span>
<span class="sd">@date = &#39;2016-03-30&#39;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">timeout</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">IncompleteRead</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>


<span class="k">class</span> <span class="nc">SafeSub</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;{&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;}&#39;</span>


<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    it is a imitation of py3.6</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mapping</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">SafeSub</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">SafeSub</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">SafeSub</span><span class="p">(</span><span class="n">mapping</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">SafeSub</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">mapping</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">read_params</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="s">&#39;--rs_file&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;rs_file&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;FILE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;set the rs file, &quot;</span>
                             <span class="s">&quot;with one rs_num per line&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--out_file&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;FILE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;./output.txt&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;set the output file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--already_file&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;already_file&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;FILE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;./already.txt&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;set the already file, &quot;</span>
                             <span class="s">&quot;with one rs_string per line &quot;</span>
                             <span class="s">&quot;shows which rs has been crawled&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--threading&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;threading&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;INT&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;how many threads will you use&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">read_already</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">rs_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rs_string</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">rs_string</span>


<span class="k">def</span> <span class="nf">read_rs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">already_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">rs_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rs_string</span> <span class="ow">and</span>
                    <span class="n">already_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">rs_string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_list</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">rs_string</span>


<span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
        <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span>
        <span class="s">&#39;application/x-www-form-urlencoded;&#39;</span>
        <span class="s">&#39;charset=utf-8&#39;</span>
    <span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
        <span class="s">&#39;User-Agent&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_0) &#39;</span>
        <span class="s">&#39;AppleWebKit/601.1.56 (KHTML, like Gecko) &#39;</span>
        <span class="s">&#39;Version/9.0 Safari/601.1.56&#39;</span>
    <span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
        <span class="s">&#39;Referer&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.ncbi.nlm.nih.gov&#39;</span>
    <span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;Host&#39;</span><span class="p">,</span> <span class="s">&#39;www.ncbi.nlm.nih.gov&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">req</span>


<span class="k">def</span> <span class="nf">parse_html</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;lxml&#39;</span><span class="p">)</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&#39;faceted_search&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">location_list</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;span&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;ui-button-text&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">location_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s">&#39;x&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maincontent</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&#39;maincontent&#39;</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">maincontent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;h2&#39;</span><span class="p">)</span>
        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_list</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_full_url</span><span class="p">()</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">try_count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">URLError</span><span class="p">,</span>
                <span class="n">IncompleteRead</span><span class="p">,</span>
                <span class="n">ConnectionResetError</span><span class="p">,</span>
                <span class="n">timeout</span><span class="p">):</span>
            <span class="n">try_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="s">&#39;error occurred, reloading {try_count} time: {url}... &#39;</span><span class="p">))</span>
            <span class="k">continue</span>


<span class="k">def</span> <span class="nf">get_clinvar_transcript</span><span class="p">(</span><span class="n">rs_string</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;http://www.ncbi.nlm.nih.gov/clinvar/?term={rs_string}&#39;</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">transcript_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">rs_string</span><span class="p">:</span> <span class="n">transcript_list</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_multiprocessing</span><span class="p">(</span><span class="n">rs_file</span><span class="p">,</span> <span class="n">already_list</span><span class="p">,</span>
                        <span class="n">out_fp</span><span class="p">,</span> <span class="n">log_fp</span><span class="p">,</span> <span class="n">threading</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">threading</span><span class="p">)</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rs_string</span> <span class="ow">in</span> <span class="n">read_rs</span><span class="p">(</span><span class="n">rs_file</span><span class="p">,</span> <span class="n">already_list</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">get_clinvar_transcript</span><span class="p">,</span>
                                  <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">rs_string</span><span class="p">,))</span>
        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="c"># 同步条件, 这里设置成了当获取的条目数等于进程池大小时同步</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threading</span><span class="p">:</span>
            <span class="c"># 同步输出函数</span>
            <span class="n">output_result</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">,</span> <span class="n">log_fp</span><span class="p">)</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_result</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">,</span> <span class="n">log_fp</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">output_result</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">out_fp</span><span class="p">,</span> <span class="n">log_fp</span><span class="p">):</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rs_id</span><span class="p">,</span> <span class="n">variant_list</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="s">&#39;{rs_id}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">variant_id</span> <span class="ow">in</span> <span class="n">variant_list</span><span class="p">:</span>
                <span class="n">out_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="s">&#39;{rs_id}</span><span class="se">\t</span><span class="s">{variant_id}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">read_params</span><span class="p">()</span>
    <span class="n">create_file</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">already_file</span><span class="p">)</span>
    <span class="n">create_file</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
    <span class="n">already_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">read_already</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">already_file</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">out_file</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">,</span> \
            <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">already_file</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">already</span><span class="p">:</span>
        <span class="n">get_multiprocessing</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">rs_file</span><span class="p">,</span> <span class="n">already_list</span><span class="p">,</span>
                            <span class="n">out</span><span class="p">,</span> <span class="n">already</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">threading</span><span class="p">)</span>
</pre></div>


<h2>文明上网, 和谐爬取</h2>
<p>再强的服务器都会有访问上限, 太频繁的爬取会影响网站性能, 希望大家注意和谐。</p>
            </div>
            <!-- /.entry-content -->

    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>
<!--         <div class="ds-thread" data-thread-key="gui-mo-hua-pa-qu-ncbi" data-title="规模化爬取NCBI" data-url="http://www.lyon0804.com/gui-mo-hua-pa-qu-ncbi.html"></div> -->
		<script type="text/javascript">
     		var duoshuoQuery = {short_name:"lyon0804"};
    		(function() {
    			var ds = document.createElement('script');
    			ds.type = 'text/javascript';ds.async = true;
    			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    			ds.charset = 'UTF-8';
    			(document.getElementsByTagName('head')[0]
    			 || document.getElementsByTagName('body')[0]).appendChild(ds);
    		})();
    	</script>
        <script type="text/javascript">
            function toggleDuoshuoComments(container, id, title, url){
                if(jQuery(container).has("div").length>0){
                    jQuery(container).empty();
                    return;
                }
                var el = document.createElement('div');
                el.setAttribute('class','ds-thread');
                el.setAttribute('data-thread-key', id);
                el.setAttribute('data-title',title);
                el.setAttribute('data-url', url);
                DUOSHUO.EmbedThread(el);
                jQuery(container).append(el);
            }
        </script>
        <a href="javascript:void(0);" onclick="toggleDuoshuoComments('#comment-box', 'gui-mo-hua-pa-qu-ncbi', '规模化爬取NCBI' , 'http://www.lyon0804.com/gui-mo-hua-pa-qu-ncbi.html');">
        查看评论</a>
        <div id="comment-box" ></div>
        <hr/>
    	<noscript>Please enable JavaScript to view the <a href="http://duoshuo.com/">comments powered by
        Duoshuo.</a></noscript>
    	<a href="http://duoshuo.com" class="dsq-brlink">comments powered by <span>Duoshuo</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
            <!-- <div class="list-group-item"> -->
            <!-- <h4> -->
            <!-- <i class="fa fa-home fa-lg"></i> -->
            <!-- <span class="icon-label">Social</span></h4> -->
              <ul class="list-group" id="social">
                   <!-- <li class="list-group-item"> -->
                   <div class="social-item">
                   <a href="http://github.com/lozybean">
                     <i class="fa fa-github-square fa-lg"></i><!--  github -->
                   </a>
                   </div>
                   <!-- </li> -->
                   <!-- <li class="list-group-item"> -->
                   <div class="social-item">
                   <a href="http://weibo.com/lyon0804">
                     <i class="fa fa-weibo fa-lg"></i><!--  weibo -->
                   </a>
                   </div>
                   <!-- </li> -->
              </ul>
            <!-- </div> -->
         <div class="col-xs-10">&copy; 2017 lyon
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3(modified by lyon)</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2" id="back-top">
            <!-- <p class="pull-right"><i class="fa fa-arrow-up"></i>  -->
            <a href="#top" title="回到顶部"></a>
            </p>
         </div>
      </div>
   </div>
</footer>
<script src="http://www.lyon0804.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://www.lyon0804.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://www.lyon0804.com/theme/js/respond.min.js"></script>


</body>
</html>